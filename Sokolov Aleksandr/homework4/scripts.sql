# WA
WITH RECURSIVE cte AS
(
  SELECT MIN(CAST(begin_dttm AS DATE)) AS dt FROM sessions
    UNION ALL
	SELECT dt + INTERVAL 1 WEEK
    FROM cte
    WHERE (dt + INTERVAL 1 WEEK <= (SELECT MAX(CAST(begin_dttm AS DATE)) FROM sessions))
)
SELECT cte.dt, COUNT(DISTINCT sessions.user_id)
  FROM sessions RIGHT JOIN cte ON CAST(sessions.begin_dttm AS DATE) >= cte.dt
  AND CAST(sessions.begin_dttm AS DATE) < cte.dt + INTERVAL 1 WEEK
  GROUP BY cte.dt
  ORDER BY cte.dt;

# 2018-08-02	6
# 2018-08-09	11
# 2018-08-16	17
# 2018-08-23	22
# 2018-08-30	30
# 2018-09-06	35
# 2018-09-13	41
# 2018-09-20	49
# 2018-09-27	51

# PPU
WITH RECURSIVE cte AS
(
  SELECT MIN(CAST(payment_dttm AS DATE)) AS dt FROM payments
    UNION ALL
	SELECT dt + INTERVAL 1 DAY
    FROM cte
    WHERE dt + INTERVAL 1 DAY <= (SELECT MAX(CAST(payment_dttm AS DATE)) FROM payments)
)
SELECT cte.dt, COALESCE(COUNT(DISTINCT payments.user_id) / COUNT(DISTINCT sessions.user_id), 0)
    FROM payments
    RIGHT JOIN cte ON CAST(payments.payment_dttm AS DATE) = cte.dt
    LEFT JOIN sessions ON CAST(sessions.begin_dttm AS DATE) = cte.dt
    GROUP BY cte.dt
    ORDER BY cte.dt;

# 2018-08-07	0.5000
# 2018-08-08	0.0000
# 2018-08-09	0.0000
# 2018-08-10	0.2000
# 2018-08-11	0.4000
# 2018-08-12	0.1667
# 2018-08-13	0.1667
# 2018-08-14	0.2222
# 2018-08-15	0.6667
# 2018-08-16	0.0909
# 2018-08-17	0.2857
# 2018-08-18	0.0769
# 2018-08-19	0.1429
# 2018-08-20	0.1250
# 2018-08-21	0.1000
# 2018-08-22	0.0000
# 2018-08-23	0.1333
# 2018-08-24	0.2857
# 2018-08-25	0.1538
# 2018-08-26	0.0000
# 2018-08-27	0.3636
# 2018-08-28	0.2500
# 2018-08-29	0.0714
# 2018-08-30	0.2105
# 2018-08-31	0.1765
# 2018-09-01	0.2222
# 2018-09-02	0.1000
# 2018-09-03	0.0000
# 2018-09-04	0.1333
# 2018-09-05	0.0625
# 2018-09-06	0.1739
# 2018-09-07	0.0833
# 2018-09-08	0.2500
# 2018-09-09	0.1154
# 2018-09-10	0.1538
# 2018-09-11	0.2174
# 2018-09-12	0.1200
# 2018-09-13	0.1154
# 2018-09-14	0.1250
# 2018-09-15	0.2069
# 2018-09-16	0.2903
# 2018-09-17	0.1538
# 2018-09-18	0.0645
# 2018-09-19	0.2500
# 2018-09-20	0.1765
# 2018-09-21	0.2353
# 2018-09-22	0.1333
# 2018-09-23	0.1563
# 2018-09-24	0.2857
# 2018-09-25	0.2368
# 2018-09-26	0.3243
# 2018-09-27	0.3889
# 2018-09-28	0.3235
# 2018-09-29	0.3023
# 2018-09-30	0.2927


# ARPPU
WITH RECURSIVE cte AS
(
  SELECT MIN(CAST(payment_dttm AS DATE)) AS dt FROM payments
    UNION ALL
	SELECT dt + INTERVAL 1 DAY
    FROM cte
    WHERE (dt + INTERVAL 1 DAY <= (SELECT MAX(CAST(payment_dttm AS DATE)) FROM payments))
)
SELECT cte.dt, SUM(payments.payment_sum) / COUNT(DISTINCT payments.user_id)
  FROM payments JOIN cte ON CAST(payments.payment_dttm AS DATE) = cte.dt
  GROUP BY cte.dt
  ORDER BY cte.dt;

# 2018-08-07	902
# 2018-08-08	0
# 2018-08-09	0
# 2018-08-10	317
# 2018-08-11	135
# 2018-08-12	330
# 2018-08-13	615
# 2018-08-14	510
# 2018-08-15	372
# 2018-08-16	28
# 2018-08-17	731.5
# 2018-08-18	839
# 2018-08-19	381.5
# 2018-08-20	508
# 2018-08-21	277
# 2018-08-22	0
# 2018-08-23	443.5
# 2018-08-24	556.25
# 2018-08-25	528.5
# 2018-08-26	0
# 2018-08-27	818.5
# 2018-08-28	633.75
# 2018-08-29	537
# 2018-08-30	476.75
# 2018-08-31	348.6666666666667
# 2018-09-01	466
# 2018-09-02	154.5
# 2018-09-03	0
# 2018-09-04	549
# 2018-09-05	800
# 2018-09-06	665.75
# 2018-09-07	584
# 2018-09-08	448.5
# 2018-09-09	510.6666666666667
# 2018-09-10	629.75
# 2018-09-11	615.2
# 2018-09-12	731.3333333333334
# 2018-09-13	532
# 2018-09-14	479.3333333333333
# 2018-09-15	586.5
# 2018-09-16	641.4444444444445
# 2018-09-17	418.25
# 2018-09-18	350
# 2018-09-19	475.375
# 2018-09-20	633.3333333333334
# 2018-09-21	553.75
# 2018-09-22	263
# 2018-09-23	733.4
# 2018-09-24	776.6
# 2018-09-25	614.2222222222222
# 2018-09-26	1056.8333333333333
# 2018-09-27	420.7857142857143
# 2018-09-28	994.2727272727273
# 2018-09-29	837.6923076923077
# 2018-09-30	1100.75