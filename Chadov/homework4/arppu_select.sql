-- ARPPU — Average Revenue Per Paying User — средний доход с одного платящего пользователя

-- вроде понял 

WITH RECURSIVE cte AS
(
    SELECT MIN(CAST(payment_dttm AS DATE)) AS dt FROM payments
        UNION ALL
	SELECT dt + INTERVAL 1 DAY
      FROM cte
     WHERE dt + INTERVAL 1 DAY <= (SELECT MAX(CAST(payment_dttm AS DATE)) FROM payments)
),
revenue AS
(
 SELECT cte.dt, COALESCE(SUM(payment_sum), 0) AS money
 FROM cte LEFT JOIN payments ON cte.dt = CAST(payment_dttm AS DATE)
 GROUP BY cte.dt
 ORDER BY cte.dt
 ),
Pu AS
(
 SELECT cte.dt, COUNT(DISTINCT payments.user_id) p_user
  FROM payments RIGHT JOIN cte ON CAST(payments.payment_dttm AS DATE) = cte.dt
 GROUP BY cte.dt
 ORDER BY cte.dt
)
 
SELECT revenue.dt, money, p_user,
        COALESCE((money/p_user), 0) arppu
FROM revenue JOIN Pu ON revenue.dt = Pu.dt;

+------------+-------+--------+--------------------+
| dt         | money | p_user | arppu              |
+------------+-------+--------+--------------------+
| 2018-08-07 |   902 |      1 |                902 |
| 2018-08-08 |     0 |      0 |                  0 |
| 2018-08-09 |     0 |      0 |                  0 |
| 2018-08-10 |   317 |      1 |                317 |
| 2018-08-11 |   270 |      2 |                135 |
| 2018-08-12 |   330 |      1 |                330 |
| 2018-08-13 |   615 |      1 |                615 |
| 2018-08-14 |  1020 |      2 |                510 |
| 2018-08-15 |  1488 |      4 |                372 |
| 2018-08-16 |    28 |      1 |                 28 |
| 2018-08-17 |  1463 |      2 |              731.5 |
| 2018-08-18 |   839 |      1 |                839 |
| 2018-08-19 |   763 |      2 |              381.5 |
| 2018-08-20 |   508 |      1 |                508 |
| 2018-08-21 |   277 |      1 |                277 |
| 2018-08-22 |     0 |      0 |                  0 |
| 2018-08-23 |   887 |      2 |              443.5 |
| 2018-08-24 |  2225 |      4 |             556.25 |
| 2018-08-25 |  1057 |      2 |              528.5 |
| 2018-08-26 |     0 |      0 |                  0 |
| 2018-08-27 |  3274 |      4 |              818.5 |
| 2018-08-28 |  2535 |      4 |             633.75 |
| 2018-08-29 |   537 |      1 |                537 |
| 2018-08-30 |  1907 |      4 |             476.75 |
| 2018-08-31 |  1046 |      3 |  348.6666666666667 |
| 2018-09-01 |  1864 |      4 |                466 |
| 2018-09-02 |   309 |      2 |              154.5 |
| 2018-09-03 |     0 |      0 |                  0 |
| 2018-09-04 |  1098 |      2 |                549 |
| 2018-09-05 |   800 |      1 |                800 |
| 2018-09-06 |  2663 |      4 |             665.75 |
| 2018-09-07 |  1168 |      2 |                584 |
| 2018-09-08 |  2691 |      6 |              448.5 |
| 2018-09-09 |  1532 |      3 |  510.6666666666667 |
| 2018-09-10 |  2519 |      4 |             629.75 |
| 2018-09-11 |  3076 |      5 |              615.2 |
| 2018-09-12 |  2194 |      3 |  731.3333333333334 |
| 2018-09-13 |  1596 |      3 |                532 |
| 2018-09-14 |  1438 |      3 |  479.3333333333333 |
| 2018-09-15 |  3519 |      6 |              586.5 |
| 2018-09-16 |  5773 |      9 |  641.4444444444445 |
| 2018-09-17 |  1673 |      4 |             418.25 |
| 2018-09-18 |   700 |      2 |                350 |
| 2018-09-19 |  3803 |      8 |            475.375 |
| 2018-09-20 |  3800 |      6 |  633.3333333333334 |
| 2018-09-21 |  4430 |      8 |             553.75 |
| 2018-09-22 |  1052 |      4 |                263 |
| 2018-09-23 |  3667 |      5 |              733.4 |
| 2018-09-24 |  7766 |     10 |              776.6 |
| 2018-09-25 |  5528 |      9 |  614.2222222222222 |
| 2018-09-26 | 12682 |     12 | 1056.8333333333333 |
| 2018-09-27 |  5891 |     14 |  420.7857142857143 |
| 2018-09-28 | 10937 |     11 |  994.2727272727273 |
| 2018-09-29 | 10890 |     13 |  837.6923076923077 |
| 2018-09-30 | 13209 |     12 |            1100.75 |
+------------+-------+--------+--------------------+